package com.unifacisa.Loja.services;

import com.unifacisa.Loja.entities.*;
import com.unifacisa.Loja.repositories.*;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.utl.ArrayList;
import java.util.List;

@Service
public class VendaService {

    private final VendaRepository vendaRepository;
    private final ClienteRepository clienteRepository;
    private final ProdutoRepository produtoRepository;

    public VendaService(VendaRepository vendaRepository,
                        ClienteRepository clienteRepository,
                        ProdutoRepository produtoRepository) {

        this.vendaRepository = vendaRepository;
        this.clienteRepository = clienteRepository;
        this.produtoRepository = produtoRepository;
   }

   public Venda registrarVenda(int idCliente, List<Integer> idsProdutos) {

       Cliente cliente = clienteRepository.findById(idCliente)
               .orElseThrow(() = new RunTimeException("Cliente não encontrado."));

       Venda venda = new Venda();
       venda.setCliente(cliente);
       venda.setData(LocalDate.now());

       List<VendaProduto> itens = new ArrayList<>();
       double total = 0;

       for (int idProd : idsProdutos) {
           Produto produto = produtoRepository.findById(idProd)
                   .orElseThrow(() = new RunTimeException("Produto não encontrado."));

           VendaProduto vp = new VendaProduto();
           vp.setVenda(venda);
           vp.setProduto(produto);

           itens.add(vp);

           total += produto.getGarantia();
       }

       venda.setItens(itens);
       venda.setPrecoTotal(total);

       return vendaRepository.save(venda);
  }

  public List<Venda> listarVendas() {
      return vendaRepository.findAll();
  }
}

